{% extends "base.html" %}
{% block title %}Preferencias{% endblock %}
{% block content %}
<h2 class="mb-4 text-center">Configurar Preferencias</h2>
<div class="d-flex justify-content-center">
  <div class="table-responsive" style="max-width: 520px;">
    <table id="prefsTable" class="table table-sm table-hover align-middle shadow-sm rounded" style="background: #fff; font-size: 0.95rem;">
      <thead class="table-dark">
        <tr>
          <th style="width: 90px;">Ticker</th>
          <th style="width: 120px;">Porcentaje</th>
          <th style="width: 80px;">Días</th>
          <th style="width: 110px; text-align: center;">Acciones</th>
        </tr>
      </thead>
      <tbody id="prefsTableBody">
        <!-- Las filas se generan por JS -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4" class="text-end">
            <button id="addPrefBtn" class="btn btn-outline-success btn-sm" title="Añadir preferencia">
              <span style="font-size: 1.3rem; line-height: 1;">&#43;</span>
            </button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
<div id="prefMsg" class="mt-3 text-center"></div>
<script>
let editingRow = null;
let preferences = [];

function renderTable() {
  const tbody = document.getElementById('prefsTableBody');
  tbody.innerHTML = '';
  if (!preferences.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No tienes preferencias guardadas.</td></tr>`;
  } else {
    preferences.forEach((pref, idx) => {
      if (editingRow === idx) {
        tbody.innerHTML += `
          <tr>
            <td class="px-2 py-1">
              <div class="relative w-48">
                <input
                  id="ticker-input"
                  name="ticker"
                  type="text"
                  autocomplete="off"
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                  placeholder="Buscar ticker..."
                  oninput="searchTicker(this.value)"
                  onblur="setTimeout(() => hideDropdown(), 200)"
                />
                <ul
                  id="ticker-dropdown"
                  class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg mt-1 hidden max-h-60 overflow-auto"
                ></ul>
              </div>
            </td>
            <td><input type="number" class="form-control form-control-sm" value="${pref.drop_percentage || ''}" min="0" max="100" id="edit-drop-${idx}" style="width: 90px;" required></td>
            <td><input type="number" class="form-control form-control-sm" value="${pref.days || ''}" min="1" max="365" id="edit-days-${idx}" style="width: 60px;" required></td>
            <td class="text-center">
              <button class="btn btn-success btn-sm me-1" onclick="saveEdit(${idx})" title="Guardar"><i class="bi bi-check-lg"></i></button>
              <button class="btn btn-secondary btn-sm" onclick="cancelEdit()" title="Cancelar"><i class="bi bi-x-lg"></i></button>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML += `
          <tr>
            <td>${pref.ticker}</td>
            <td>${pref.drop_percentage}%</td>
            <td>${pref.days}</td>
            <td class="text-center">
              <button class="btn btn-outline-primary btn-sm me-1" onclick="editPref(${idx})" title="Editar"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger btn-sm" onclick="deletePref(${idx})" title="Borrar"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
        `;
      }
    });
  }
}

function loadPreferences() {
  fetch('/api/preferences', { credentials: 'same-origin' })
    .then(r => {
      if (r.status === 401 || r.status === 403) {
        window.location.href = '/login';
        return [];
      }
      if (!r.ok) {
        document.getElementById('prefMsg').textContent = 'Error al cargar preferencias';
        return [];
      }
      return r.json();
    })
    .then(data => {
      preferences = Array.isArray(data) ? data : [];
      editingRow = null;
      renderTable();
    });
}

function addPrefRow() {
  if (editingRow !== null) return;
  preferences.push({ ticker: '', drop_percentage: '', days: '' });
  editingRow = preferences.length - 1;
  renderTable();
}

function saveEdit(idx) {
  const ticker = document.getElementById('ticker-input').value.trim();
  const drop = document.getElementById(`edit-drop-${idx}`).value;
  const days = document.getElementById(`edit-days-${idx}`).value;
  if (!ticker || drop === '' || days === '') {
    document.getElementById('prefMsg').textContent = 'Todos los campos son obligatorios.';
    return;
  }
  const isNew = !preferences[idx].id;
  const url = isNew ? '/api/preferences/add' : `/api/preferences/${preferences[idx].id}`;
  const method = isNew ? 'POST' : 'PUT';
  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    credentials: 'same-origin',
    body: JSON.stringify({ ticker, drop_percentage: drop, days })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('prefMsg').textContent = '';
      loadPreferences();
    } else {
      document.getElementById('prefMsg').textContent = data.message || 'Error al guardar preferencia.';
    }
  })
  .catch(() => {
    document.getElementById('prefMsg').textContent = 'Error de red o de servidor.';
  });
}

function editPref(idx) {
  editingRow = idx;
  renderTable();
}

function cancelEdit() {
  loadPreferences();
}

function deletePref(idx) {
  if (!preferences[idx].id) {
    preferences.splice(idx, 1);
    renderTable();
    return;
  }
  fetch(`/api/preferences/${preferences[idx].id}`, {
    method: 'DELETE',
    credentials: 'same-origin'
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loadPreferences();
    } else {
      document.getElementById('prefMsg').textContent = data.message || 'Error al borrar preferencia.';
    }
  })
  .catch(() => {
    document.getElementById('prefMsg').textContent = 'Error de red o de servidor.';
  });
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('addPrefBtn').addEventListener('click', addPrefRow);
  loadPreferences();
});

let lastQuery = "";
function searchTicker(query) {
  const dropdown = document.getElementById('ticker-dropdown');
  if (query.length < 2) {
    dropdown.classList.add('hidden');
    return;
  }
  if (query === lastQuery) return;
  lastQuery = query;
  fetch('/api/ticker/search', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({query})
  })
  .then(res => res.json())
  .then(data => {
    dropdown.innerHTML = '';
    if (data.tickers && data.tickers.length > 0) {
      data.tickers.forEach(ticker => {
        const li = document.createElement('li');
        li.className = 'px-4 py-2 cursor-pointer hover:bg-blue-100 transition';
        li.textContent = `${ticker.symbol} - ${ticker.name}`;
        li.onclick = () => {
          selectTicker(ticker.symbol);
          // Borra la lista en vez de ocultarla
          dropdown.innerHTML = '';
          dropdown.classList.add('hidden');
        };
        dropdown.appendChild(li);
      });
      dropdown.classList.remove('hidden');
    } else {
      dropdown.classList.add('hidden');
    }
  });
}
function selectTicker(symbol) {
  document.getElementById('ticker-input').value = symbol;
  hideDropdown();
  lastQuery = symbol;
}
function hideDropdown() {
  document.getElementById('ticker-dropdown').classList.add('hidden');
}
// Cambia el onblur del input para usar el flag
document.addEventListener('DOMContentLoaded', function() {
  const tickerInput = document.getElementById('ticker-input');
  if (tickerInput) {
    tickerInput.onblur = function() {
      setTimeout(() => {
        if (!dropdownClicked) hideDropdown();
        dropdownClicked = false;
      }, 100);
    };
  }
});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}